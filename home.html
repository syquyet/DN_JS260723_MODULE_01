<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Add padding to containers */
      .container {
        padding: 16px;
        background-color: white;
      }

      /* Full-width input fields */
      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 15px;
        margin: 5px 0 22px 0;
        display: inline-block;
        border: none;
        background: #f1f1f1;
      }

      input[type="text"]:focus,
      input[type="password"]:focus {
        background-color: #ddd;
        outline: none;
      }

      /* Overwrite default styles of hr */
      hr {
        border: 1px solid #f1f1f1;
        margin-bottom: 25px;
      }

      /* Set a style for the submit button */
      .registerbtn {
        background-color: #04aa6d;
        color: white;
        padding: 16px 20px;
        margin: 8px 0;
        border: none;
        cursor: pointer;
        width: 100%;
        opacity: 0.9;
      }

      .registerbtn:hover {
        opacity: 1;
      }

      /* Add a blue text color to links */
      a {
        color: dodgerblue;
      }

      /* Set a grey background color and center the text of the "sign in" section */
      .signin {
        background-color: #f1f1f1;
        text-align: center;
      }

      .modal {
        position: fixed;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: #242222b6;
        display: none;
        justify-content: center;
        align-items: center;
      }
      form {
        width: 500px;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
      }
      button {
        padding: 10px;
      }
      .toggle {
        display: flex !important;
      }
      .fadeIn {
        animation: fadeInAnimation ease 1s;
      }
      .fadeOut {
        animation: fadeOutAnimation ease 1s;
      }

      @keyframes fadeInAnimation {
        0% {
          transform: scale(0);
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes fadeOutAnimation {
        0% {
          transform: scale(1);
        }
        100% {
          transform: scale(0);
        }
      }
      .error {
        color: red;
        font-size: 1.1em;
        margin-bottom: 20px;
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <button onclick="handleToggle()">Đăng ký</button>
    <div class="modal">
      <form>
        <div class="container">
          <h1>Register</h1>
          <p>Please fill in this form to create an account.</p>
          <hr />

          <label for="email"><b>Email</b></label>
          <input
            type="text"
            placeholder="Enter Email"
            name="email"
            id="email"
          />
          <p class="error" id="error-email"></p>

          <label for="password"><b>Password</b></label>
          <input
            type="password"
            placeholder="Enter Password"
            name="password"
            id="password"
          />
          <p class="error" id="error-password"></p>

          <label for="password-repeat"><b>Repeat Password</b></label>
          <input
            type="password"
            placeholder="Repeat Password"
            name="password-repeat"
            id="password-repeat"
          />
          <p class="error" id="error-repeat-password"></p>
          <hr />
          <p>
            By creating an account you agree to our
            <a href="#">Terms & Privacy</a>.
          </p>

          <button type="submit" class="registerbtn">Register</button>
        </div>

        <div class="container signin">
          <p>Already have an account? <a href="#">Sign in</a>.</p>
        </div>
      </form>
    </div>
  </body>
  <script>
    const accounts = [];
    const modalElement = document.querySelector(".modal");
    const formElement = document.querySelector("form");
    const emailElement = document.querySelector("#email");
    const passwordElement = document.querySelector("#password");
    const repeatPasswordElement = document.querySelector("#password-repeat");
    function handleToggle() {
      modalElement.classList.add("toggle");
      formElement.style.animation = "fadeInAnimation ease 1s";
    }
    formElement.addEventListener("submit", (e) => {
      // Chặn action của e
      e.preventDefault();

      //   B1: Lấy user từ form
      const user = getUser(); // { emai: "", password: "", repeatPassword: ""}

      // B2:  Check validator
      const error = checkError(user); // { } --> chứa thông tin lỗi
      renderError(error); // hiển thị loại

      if (error.isError) {
        return;
      }

      // B3:  Kiểm tra email có tồn tai trên database
      const accountsDB = JSON.parse(localStorage.getItem("accounts")) || [];

      let isExist = false;
      //for
      for (const account of accountsDB) {
        if (account.email === user.email) {
          isExist = true;
          break;
        }
      }

      //   B4: Điều hướng login
      if (!isExist) {
        // Ok --> đẩy lên local
        delete user.repeatPassword;
        accountsDB.push(user);

        localStorage.setItem("accounts", JSON.stringify(accountsDB));
        // Điều hướng login
      } else {
        error.isError = true;
        error.msgEmail =
          "Email đã tồn tại, vui lòng đăng nhập hoặc đăng ký email khác";
        console.log(1111, error);
        renderError(error);
      }
    });

    function getUser() {
      return {
        email: emailElement.value.toLowerCase().trim(),
        password: passwordElement.value,
        repeatPassword: repeatPasswordElement.value,
      };
    }
    function checkError(user) {
      const error = {
        isError: false,
        msgEmail: "",
        msgPassword: "",
        msgRepeatPassword: "",
      };

      const validRegex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
      if (user.password !== user.repeatPassword) {
        error.isError = true;
        error.msgRepeatPassword =
          "Mật khẩu không trùng khớp, vui lòng nhập lại";
      }
      if (!user.password) {
        error.isError = true;
        error.msgPassword = "Mật khẩu không được để trống";
      }

      if (!user.email.match(validRegex)) {
        error.isError = true;
        error.msgEmail = "Email không đúng định dạng";
      }

      return error;
    }

    function renderError(error) {
      const errorEmailElement = document.querySelector("#error-email");
      const errorPasswordElement = document.querySelector("#error-password");
      const errorRepeatPasswordElement = document.querySelector(
        "#error-repeat-password"
      );

      errorEmailElement.textContent = error.msgEmail;
      errorPasswordElement.textContent = error.msgPassword;
      errorRepeatPasswordElement.textContent = error.msgRepeatPassword;
    }
  </script>
</html>
